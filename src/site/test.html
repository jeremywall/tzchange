<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.1/css/bootstrap.min.css" integrity="sha512-6KY5s6UI5J7SVYuZB4S/CZMyPylqyyNZco376NM2Z8Sb8OxEdp02e1jkKk/wZxIEmjQ6DRCEBhni+gpr9c4tvA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<style type="text/css">
* {
  font-family: 'Roboto', sans-serif;
}

body {
  font-family: 'Roboto', sans-serif;
}

p {
  font-family: 'Roboto', sans-serif;
}
  
tr.time-zone-break {
  border-top: double;
}
</style>
<title>Time Zone Change</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div id="" class="col"><h1>Time Zone Change</h1></div>
        </div>
        <div class="row">
            <div id="" class="col">Time Zone Database Version: <span id="tzdb-version"></span></div>
        </div>
        <div class="row">
            <div id="" class="col">
                <a href="https://www.timeanddate.com/news/time/">Time Zone News</a> | 
                <a href="https://www.iana.org/time-zones">IANA Time Zone Database</a> | 
                <a href="https://momentjs.com/timezone/">Moment Timezone</a> | 
                <a href="/next-change.json">JSON Version</a> | 
                <a href="https://github.com/jeremywall/tzchange">GitHub</a>
            </div>
        </div>
        <div class="row">
            <div id="" class="col">
                <table class="table table-bordered table-hover table-sm" id="tz-changes">
                    <thead></thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.1/js/bootstrap.bundle.min.js" integrity="sha512-trzlduO3EdG7Q0xK4+A+rPbcolVt37ftugUSOvrHhLR5Yw5rsfWXcpB3CPuEBcRBCHpc+j18xtQ6YrtVPKCdsg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.slim.min.js" integrity="sha512-6ORWJX/LrnSjBzwefdNUyLCMTIsGoNP6NftMy2UAm1JBm6PRZCO1d7OHBStWpVFZLO+RerTvqX/Z9mBFfCJZ4A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/tzdata-factory@1.0.30/tzdata-factory.js"></script>
<script src="https://unpkg.com/tzdata@1.0.30/tzdata.js"></script>
<script src="https://unpkg.com/timezonecomplete@5.12.4/dist/timezonecomplete.min.js"></script>
<script>
function getQueryParam(name) {
  var results = new RegExp('[\?&]' + name + '=([^]*)').exec(window.location.href);
  if (results == null){
    return null;
  } else {
    return decodeURIComponent(results[1]) || 0;
  }
}

function clearTable() {
  var $thead = $('<thead/>');
  var $tbody = $('<tbody/>');
  var $tfoot = $('<tfoot/>');
  $('table#tz-changes thead').replaceWith($thead);
  $('table#tz-changes tbody').replaceWith($tbody);
  $('table#tz-changes tfoot').replaceWith($tfoot);
}

function generateTable() {
  var utc = tc.nowUtc();
  console.log(utc);
  console.log(tzdataFactory);
  return;
  var zones = moment.tz.names();
  var $tbody = $('<tbody/>');
  var ts = getQueryParam('ts');
  var startingMoment = null;
  if (ts == null) {
    startingMoment = moment();
  } else {
    if (!_.isNaN(_.toNumber(ts))) {
      startingMoment = moment.unix(ts);
    } else {
      startingMoment = moment(ts);
      if (!startingMoment.isValid()) {
        startingMoment = moment();
      }
    }
  }
  var rowsData = [];
  $.each(zones, function(index, zoneName) {
    var zone = moment.tz.zone(zoneName);
    var nextChangeIndex = _.sortedIndex(zone.untils, startingMoment.valueOf());
    var nextChangeEpochMillis = zone.untils[nextChangeIndex];
    if (_.isFinite(nextChangeEpochMillis)) {
      rowsData.push({
        zone: zone,
        nextChangeIndex: nextChangeIndex
      });
    } else {
      console.log("Excluding zone: " + zone.name);
    }  
  });
  var rowsDataGrouped = _.chain(rowsData)
    .orderBy([function(rowData) { return rowData.zone.untils[rowData.nextChangeIndex]; }, 'zone.name'], ['asc', 'asc'])
    .groupBy(function(rowData) { return rowData.zone.untils[rowData.nextChangeIndex]; })
    .value();
  console.log(rowsDataGrouped);
  //_.orderBy(rowsData, [function(rowData) { return rowData.zone.untils[rowData.nextChangeIndex]; }, 'zone.name'], ['asc', 'asc']);
  var groupCounter = 0;
  var rowCounter = 0;
  $.each(rowsDataGrouped, function(groupIndex, rowDataGroup) {
    groupCounter++;
    $.each(rowDataGroup, function(rowIndex, rowData) {
      rowCounter++;
      var nextChangeEpochMillis = rowData.zone.untils[rowData.nextChangeIndex];
      var nextChangeDiffSecs = Math.floor((nextChangeEpochMillis - startingMoment.valueOf()) / 1000);
      var nextChangeDiff = {
        d: Math.floor(nextChangeDiffSecs / 86400),
        h: Math.floor(nextChangeDiffSecs % 86400 / 3600) ,
        m: Math.floor(nextChangeDiffSecs % 86400 % 3600 / 60),
        s: Math.floor(nextChangeDiffSecs % 86400 % 3600 % 60)
      };
      var currOffsetMins = -1 * rowData.zone.utcOffset(startingMoment.valueOf());
      var currOffset = {
        p: (currOffsetMins < 0) ? '-' : '+',
        h: Math.floor(Math.abs(currOffsetMins) / 60),
        m: Math.floor(Math.abs(currOffsetMins) % 60)
      };
      var nextOffsetMins = -1 * rowData.zone.utcOffset(nextChangeEpochMillis);
      var nextOffset = {
        p: (nextOffsetMins < 0) ? '-' : '+',
        h: Math.floor(Math.abs(nextOffsetMins) / 60),
        m: Math.floor(Math.abs(nextOffsetMins) % 60)
      };

      var $tr = $('<tr/>')
      if (rowIndex == 0) {
        $tr.addClass('time-zone-break');
      }
      if (nextChangeDiff.d < 15) {
        $tr.addClass('table-danger');
      } else if (nextChangeDiff.d < 30) {
        $tr.addClass('table-warning');
      }
      if (rowIndex == 0) {
        $tr.append($('<td rowspan="' + rowDataGroup.length + '"/>').text(groupCounter));
      }
      $tr.append($('<td/>').text(rowIndex + 1));
      $tr.append($('<td/>').text(rowCounter));
      $tr.append($('<td/>').text(nextChangeDiff.d + 'd ' + nextChangeDiff.h + 'h ' + nextChangeDiff.m + 'm ' + nextChangeDiff.s + 's '));
      $tr.append($('<td/>').text(moment.utc(nextChangeEpochMillis).format('X')));
      $tr.append($('<td/>').text(moment.utc(nextChangeEpochMillis).format('YYYY-MM-DD HH:mm:ss ddd')));
      $tr.append($('<td/>').text(moment.utc(nextChangeEpochMillis - 1000).tz("America/Los_Angeles").format('YYYY-MM-DD HH:mm:ss ddd')));
      $tr.append($('<td/>').text(moment.utc(nextChangeEpochMillis - 1000).tz(rowData.zone.name).format('YYYY-MM-DD HH:mm:ss ddd')));
      $tr.append($('<td/>').text(rowData.zone.name));
      $tr.append($('<td/>').text('UTC' + currOffset.p + _.padStart(currOffset.h, 2, '0') + _.padStart(currOffset.m, 2, '0')));
      $tr.append($('<td/>').text('UTC' + nextOffset.p + _.padStart(nextOffset.h, 2, '0') + _.padStart(currOffset.m, 2, '0')));
      $tbody.append($tr);
    })
  });

  var $thead = $('<thead class="thead-dark"/>').append(
    $('<tr/>')
      .append($('<th/>').text(''))
      .append($('<th/>').text(''))
      .append($('<th/>').text(''))
      .append($('<th/>').text('Countdown'))
      .append($('<th/>').text('Epoch of Change'))
      .append($('<th/>').text('UTC Time of Change'))
      .append($('<th/>').html('One Second Before<br>US/LA Time of Change'))
      .append($('<th/>').html('One Second Before<br>Local Time of Change'))
      .append($('<th/>').text('Zone'))
      .append($('<th/>').text('Offset Before'))
      .append($('<th/>').text('Offset After'))
  );

  var $tfoot = $thead.clone();
  
  $('span#tzdb-version').text(moment.tz.dataVersion);
  $('table#tz-changes thead').replaceWith($thead);
  $('table#tz-changes tbody').replaceWith($tbody);
  $('table#tz-changes tfoot').replaceWith($tfoot);
}

$(function() {
  clearTable();
  generateTable();
});
</script>
</body>
</html>
