<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.1/css/bootstrap.min.css" integrity="sha512-6KY5s6UI5J7SVYuZB4S/CZMyPylqyyNZco376NM2Z8Sb8OxEdp02e1jkKk/wZxIEmjQ6DRCEBhni+gpr9c4tvA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<style type="text/css">
* {
  font-family: 'Roboto', sans-serif;
}

body {
  font-family: 'Roboto', sans-serif;
}

p {
  font-family: 'Roboto', sans-serif;
}
  
tr.time-zone-break {
  border-top: double;
}
</style>
<title>Time Zone Change</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div id="" class="col"><h1>Time Zone Change</h1></div>
        </div>
        <div class="row">
            <div id="" class="col">Time Zone Database Version: <span id="tzdb-version"></span></div>
        </div>
        <div class="row">
            <div id="" class="col">
                <a href="https://www.timeanddate.com/news/time/">Time Zone News</a> | 
                <a href="https://www.iana.org/time-zones">IANA Time Zone Database</a> | 
                <a href="https://momentjs.com/timezone/">Moment Timezone</a> | 
                <a href="/next-change.json">JSON Version</a> | 
                <a href="https://github.com/jeremywall/tzchange">GitHub</a>
            </div>
        </div>
        <div class="row">
            <div id="" class="col">
                <table class="table table-bordered table-hover table-sm" id="tz-changes">
                    <thead></thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.1/js/bootstrap.bundle.min.js" integrity="sha512-trzlduO3EdG7Q0xK4+A+rPbcolVt37ftugUSOvrHhLR5Yw5rsfWXcpB3CPuEBcRBCHpc+j18xtQ6YrtVPKCdsg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.slim.min.js" integrity="sha512-6ORWJX/LrnSjBzwefdNUyLCMTIsGoNP6NftMy2UAm1JBm6PRZCO1d7OHBStWpVFZLO+RerTvqX/Z9mBFfCJZ4A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/tzdata-factory@1.0.30/tzdata-factory.js"></script>
<script src="https://unpkg.com/tzdata@1.0.30/tzdata.js"></script>
<script src="https://unpkg.com/timezonecomplete@5.12.4/dist/timezonecomplete.min.js"></script>
<script>
function getQueryParam(name) {
  var results = new RegExp('[\?&]' + name + '=([^]*)').exec(window.location.href);
  console.log('results', results);
  if (results == null){
    console.log("aaa");
    return null;
  } else {
    console.log("bbb");
    return decodeURIComponent(results[1]);
  }
}

function clearTable() {
  var $thead = $('<thead/>');
  var $tbody = $('<tbody/>');
  var $tfoot = $('<tfoot/>');
  $('table#tz-changes thead').replaceWith($thead);
  $('table#tz-changes tbody').replaceWith($tbody);
  $('table#tz-changes tfoot').replaceWith($tfoot);
}

function generateTable() {

  var tzdb = tc.TzDatabase.instance();
  var zones = tzdb.zoneNames();
  var tsSecs = getQueryParam('ts');
  if (_.isNil(tsSecs)) {
    tsSecs = Math.floor(Date.now() / 1000);
  } else {
    tsSecs = _.toNumber(tsSecs);
    if (!_.isFinite(tsSecs)) {
      tsSecs = Math.floor(Date.now() / 1000);
    }    
  }
  var tsMillis = tsSecs * 1000;

  var rowsData = [];
  $.each(zones, function(index, zoneName) {
    try {
      var nextChangeEpochMillis = tzdb.nextDstChange(zoneName, tsMillis);
      if (_.isFinite(nextChangeEpochMillis)) {
        //console.log('next change for ' + zoneName + ' is ' + nextChangeEpochMillis);
        rowsData.push({
          zoneName: zoneName,
          nextChange: nextChangeEpochMillis
        });
      } else {
        //console.log("Excluding zone: " + zoneName + " as it has no future DST change");
      }
    } catch(error) {
      console.log("Error with zone: " + zoneName);
      console.log(error)
    }
  });
  var rowsDataGrouped = _.chain(rowsData)
    .orderBy(['nextChange', 'zoneName'], ['asc', 'asc'])
    .groupBy(['nextChange'])
    .value();
  console.log(rowsDataGrouped);

  var groupCounter = 0;
  var rowCounter = 0;
  var $tbody = $('<tbody/>');
  var timezoneLA = tc.TimeZone.zone("America/Los_Angeles");
  $.each(rowsDataGrouped, function(groupIndex, rowDataGroup) {
    groupCounter++;
    $.each(rowDataGroup, function(rowIndex, rowData) {
      rowCounter++;
      var nextChangeEpochMillis = rowData.nextChange;
      var nextChangeDiffSecs = Math.floor((nextChangeEpochMillis - tsMillis) / 1000);
      var nextChangeDiff = {
        d: Math.floor(nextChangeDiffSecs / 86400),
        h: Math.floor(nextChangeDiffSecs % 86400 / 3600) ,
        m: Math.floor(nextChangeDiffSecs % 86400 % 3600 / 60),
        s: Math.floor(nextChangeDiffSecs % 86400 % 3600 % 60)
      };
      var currOffsetMins = -1 * tzdb.totalOffset(rowData.zoneName, tsMillis).minutes();
      var currOffset = {
        p: (currOffsetMins < 0) ? '-' : '+',
        h: Math.floor(Math.abs(currOffsetMins) / 60),
        m: Math.floor(Math.abs(currOffsetMins) % 60)
      };
      var nextOffsetMins = -1 * tzdb.totalOffset(rowData.zoneName, nextChangeEpochMillis).minutes();
      var nextOffset = {
        p: (nextOffsetMins < 0) ? '-' : '+',
        h: Math.floor(Math.abs(nextOffsetMins) / 60),
        m: Math.floor(Math.abs(nextOffsetMins) % 60)
      };

      var nextChangeEpochDateTime = new tc.DateTime(nextChangeEpochMillis, tc.TimeZone.utc());

      var $tr = $('<tr/>')
      if (rowIndex == 0) {
        $tr.addClass('time-zone-break');
      }
      if (nextChangeDiff.d < 15) {
        $tr.addClass('table-danger');
      } else if (nextChangeDiff.d < 30) {
        $tr.addClass('table-warning');
      }
      if (rowIndex == 0) {
        $tr.append($('<td rowspan="' + rowDataGroup.length + '"/>').text(groupCounter));
      }
      $tr.append($('<td/>').text(rowIndex + 1));
      $tr.append($('<td/>').text(rowCounter));
      $tr.append($('<td/>').text(nextChangeDiff.d + 'd ' + nextChangeDiff.h + 'h ' + nextChangeDiff.m + 'm ' + nextChangeDiff.s + 's '));
      $tr.append($('<td/>').text(Math.floor(nextChangeEpochDateTime.unixUtcMillis() / 1000)));
      $tr.append($('<td/>').text(nextChangeEpochDateTime.format('yyyy-MM-dd HH:mm:ss EEE')));
      $tr.append($('<td/>').text(nextChangeEpochDateTime.sub(1, tc.TimeUnit.Second).toZone(timezoneLA).format('yyyy-MM-dd HH:mm:ss EEE')));
      $tr.append($('<td/>').text(nextChangeEpochDateTime.sub(1, tc.TimeUnit.Second).toZone(tc.TimeZone.zone(rowData.zoneName)).format('yyyy-MM-dd HH:mm:ss EEE')));
      $tr.append($('<td/>').text(rowData.zoneName));
      $tr.append($('<td/>').text('UTC' + currOffset.p + _.padStart(currOffset.h, 2, '0') + _.padStart(currOffset.m, 2, '0')));
      $tr.append($('<td/>').text('UTC' + nextOffset.p + _.padStart(nextOffset.h, 2, '0') + _.padStart(currOffset.m, 2, '0')));
      $tbody.append($tr);
    })
  });

  var $thead = $('<thead class="thead-dark"/>').append(
    $('<tr/>')
      .append($('<th/>').text(''))
      .append($('<th/>').text(''))
      .append($('<th/>').text(''))
      .append($('<th/>').text('Countdown'))
      .append($('<th/>').text('Epoch of Change'))
      .append($('<th/>').text('UTC Time of Change'))
      .append($('<th/>').html('One Second Before<br>US/LA Time of Change'))
      .append($('<th/>').html('One Second Before<br>Local Time of Change'))
      .append($('<th/>').text('Zone'))
      .append($('<th/>').text('Offset Before'))
      .append($('<th/>').text('Offset After'))
  );

  var $tfoot = $thead.clone();
  
  $('span#tzdb-version').text(tzdataFactory.version);
  $('table#tz-changes thead').replaceWith($thead);
  $('table#tz-changes tbody').replaceWith($tbody);
  $('table#tz-changes tfoot').replaceWith($tfoot);
}

$(function() {
  clearTable();
  generateTable();
});
</script>
</body>
</html>
